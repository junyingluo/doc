### 字符设备

- 一个内核模块

* 只能顺序读写，不能随机读取，常见的字符设备有鼠标、键盘、串口、控制台和 LED 等。

* 一般每个字符设备或者块设备都会在 /dev 目录下对应一个设备文件。 Linux 用户层程序通过设备文件来使用驱动程序操作字符设备或块设备。

* /proc/devices：保存已经注册的设备类型

* /dev：设备节点，即，具体设备

### 设备号

- 主设备号：表示设备类型

- 次设备号：表示某个设备类型下具体设备

* 注册设备号

  - int register_chrdev_region(dev_t from, unsigned int count, const char \*name);

    - 手动指定设备号
    - from：起始设备号，由主设备号和起始次设备号组成
    - count：次设备号数量
    - name：设备类型的名字，会显示在 /proc/devices 中

    ```c
    dev_t devno = MKDEV(240, 0);
    register_chrdev_region(devno, 2, "globalmem");
    ```

  - int alloc_chrdev_region(dev_t *dev, unsigned int firstminor, unsigned int count, const char *name);

    - 由系统自动分配主设备号
    - firstminor：起始次设备号
    - count：次设备号数量
    - name：设备类型的名字，会显示在 /proc/devices 中

    ```c
    dev_t dev;
    alloc_chrdev_region(&dev, 0, count, DEMO_NAME);
    major = MAJOR(dev);
    minor = MINOR(dev);
    ```

### 设备类型（/proc/devices）

- 设备类型，可以通过代码自动创建

```c
dev_t dev;
alloc_chrdev_region(&dev, 0, count, DEMO_NAME);
struct cdev *demo_cdev = cdev_alloc();
cdev_init(demo_cdev, &demodrv_fops);
cdev_add(demo_cdev, dev, count);
```

### file_operations

- release 方法

  - close 是用户空间主动发起的系统调用，用于关闭某个文件描述符，主要作用是减少设备的引用计数。
  - release 是内核在设备引用计数归 0 时触发的驱动回调，用于最终释放设备资源，是驱动层的 “收尾工作”。

```c
static const struct file_operations demodrv_fops = {
	.owner = THIS_MODULE,
	.open = demodrv_open,
	.release = demodrv_release,
	.read = demodrv_read,
	.write = demodrv_write
};
```
