### MyTest

```c
#include <linux/module.h>
#include <linux/init.h>

static int __init my_test_init(void)
{
	printk("hello world, i am benshushu\n");
	return 0;
}

static void __exit my_test_exit(void)
{
	printk("goodbye\n");
}

module_init(my_test_init);
module_exit(my_test_exit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("rlk");
MODULE_DESCRIPTION("hello world module");
```

### Makefile

- Linux 内核头文件
  - 当前主机，在 /lib/modules/$(shell uname -r)/build

* make

  - -C：改变目录（Change Directory）
  - -M：指定模块源码路径

* makefile
  - obj-m：表示将源文件编译为可加载模块（.ko 文件）。这些模块可以在运行时通过 insmod 或 modprobe 动态加载到内核中。
  - obj-y：表示将源文件直接编译进内核（Built-in）。这些代码会成为内核镜像（如 vmlinuz）的一部分，系统启动时自动加载。

```Makefile
#BASEINCLUDE ?= /home/rlk/rlk/runninglinuxkernel_5.0
BASEINCLUDE ?= /lib/modules/`uname -r`/build

CONFIG_MODULE_SIG=n

mytest-objs := my_test.o

obj-m	:=   mytest.o
all :
	$(MAKE) -C $(BASEINCLUDE) M=$(PWD) modules;

clean:
	$(MAKE) -C $(BASEINCLUDE) M=$(PWD) clean;
	rm -f *.ko;
```

### 在 QEMU 虚拟机中本地编译内核模块

- cd runninglinuxkernel_5.0/

  sudo ./run_rlk_arm64.sh run

* cd /mnt/rlk_lab/rlk_basic/chapter_1_quick_start/lab3_hello_world
* make 编译
* modinfo ./mytest.ko
  ```
  filename:       /mnt/rlk_lab/rlk_basic/chapter_5_module/lab1_simple_module/./mytest.ko
  license:        GPL
  author:         rlk
  description:    my test kernel module
  alias:          mytest
  vermagic:       5.0.0+ SMP mod_unload modversions aarch64
  name:           mytest
  depends:
  ```

### 安装内核模块

- insmod mytest.ko 安装模块

- dmesg 查看打印消息

  hello world, i am benshushu

- lsmod

  ```
  Module                  Size  Used by
  mytest                 16384  0
  ```

- rmmod mytest 删除模块

### 使用 ModProbe 安装模块

- 从系统标准模块目录加载模块，并自动处理依赖关系。它不直接支持通过绝对路径加载非标准目录的模块

  - 例如，如果 foo 依赖 bar，那么 insmod 就需要先 insmod bar，然后 insmod foo，而 modprobe 则直接 modprobe foo 即可

- mkdir /lib/modules/$(uname -r)/kernel/extra/
- cp ./mytest.ko /lib/modules/$(uname -r)/kernel/extra/
- depmod -a

  更新模块依赖关系（必须执行，否则 modprobe 可能找不到模块）

- modprobe mytest 安装模块

- modprobe -r mytest 卸载模块
