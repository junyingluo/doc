### selectTiles

```js
Cesium3DTilesetBaseTraversal.selectTiles = function (tileset, frameState) {
  tileset._requestedTiles.length = 0;
  tileset._selectedTiles.length = 0;
  tileset._selectedTilesToStyle.length = 0;
  tileset._emptyTiles.length = 0;
  tileset.hasMixedContent = false;

  const root = tileset.root;
  Cesium3DTilesetTraversal.updateTile(root, frameState);

  if (!root.isVisible) {
    return;
  }

  if (
    root.getScreenSpaceError(frameState, true) <=
    tileset.memoryAdjustedScreenSpaceError
  ) {
    return;
  }

  executeTraversal(root, frameState);

  traversal.stack.trim(traversal.stackMaximumLength);
  emptyTraversal.stack.trim(emptyTraversal.stackMaximumLength);

  // Update the priority for any requests found during traversal
  // Update after traversal so that min and max values can be used to normalize priority values
  const requestedTiles = tileset._requestedTiles;
  for (let i = 0; i < requestedTiles.length; ++i) {
    requestedTiles[i].updatePriority();
  }
};
```

### executeTraversal

```js
function executeTraversal(root, frameState) {
  const { tileset } = root;

  const { canTraverse, loadTile, visitTile, touchTile } =
    Cesium3DTilesetTraversal;
  const stack = traversal.stack;
  stack.push(root);

  while (stack.length > 0) {
    traversal.stackMaximumLength = Math.max(
      traversal.stackMaximumLength,
      stack.length,
    );

    const tile = stack.pop();

    const parent = tile.parent;
    // 根节点 parentRefines 为 true
    const parentRefines = !defined(parent) || parent._refines;

    // canTraverse 如果返回 true，表示当前瓦片精度不够，需要继续加载子瓦片
    // updateAndPushChildren 如果返回 true，表示存在可以渲染的子瓦片
    tile._refines = canTraverse(tile)
      ? updateAndPushChildren(tile, stack, frameState) && parentRefines
      : false;
    // stoppedRefining 为 true 表示，不存在可以渲染的子瓦片
    const stoppedRefining = !tile._refines && parentRefines;

    if (!tile.hasRenderableContent) {
      // 没有 content 但是有 children
      tileset._emptyTiles.push(tile);
      loadTile(tile, frameState);
      if (stoppedRefining) {
        selectDesiredTile(tile, frameState);
      }
    } else if (tile.refine === Cesium3DTileRefine.ADD) {
      selectDesiredTile(tile, frameState);
      loadTile(tile, frameState);
    } else if (tile.refine === Cesium3DTileRefine.REPLACE) {
      // REPLACE 表示当前 tile 如果精度不够，会被替换
      loadTile(tile, frameState);
      // 不存在可以渲染子瓦片，因此只能渲染该瓦片
      if (stoppedRefining) {
        selectDesiredTile(tile, frameState);
      }
    }

    visitTile(tile, frameState);
    touchTile(tile, frameState);
  }
}
Cesium3DTilesetTraversal.canTraverse = function (tile) {
  if (tile.children.length === 0) {
    return false;
  }
  ...
  return tile._screenSpaceError > tile.tileset.memoryAdjustedScreenSpaceError;
};
function updateAndPushChildren(tile, stack, frameState) {
  const { tileset, children } = tile;
  const { updateTile, loadTile, touchTile } = Cesium3DTilesetTraversal;

  for (let i = 0; i < children.length; ++i) {
    updateTile(children[i], frameState);
  }

  // Sort by distance to take advantage of early Z and reduce artifacts
  children.sort(Cesium3DTilesetTraversal.sortChildrenByDistanceToCamera);

  let anyChildrenVisible = false;

  for (let i = 0; i < children.length; ++i) {
    const child = children[i];
    if (child.isVisible) {
      stack.push(child);
      anyChildrenVisible = true;
    }
  }

  return anyChildrenVisible;
}
```

- loadTile
  - 把需要下载 tile 的提交到 \_requestedTiles

  ```js
  Cesium3DTilesetTraversal.loadTile = function (tile, frameState) {
    const { tileset } = tile;
    ...
    tileset._requestedTiles.push(tile);
  };
  ```

- selectDesiredTile
  - 把需要渲染 tile 的提交到 \_selectedTiles

  ```js
  function selectDesiredTile(tile, frameState) {
    if (tile.contentAvailable) {
      Cesium3DTilesetTraversal.selectTile(tile, frameState);
    }
  }
  Cesium3DTilesetTraversal.selectTile = function (tile, frameState) {
    if (tile.contentVisibility(frameState) === Intersect.OUTSIDE) {
      return;
    }
    ......
    tileset._selectedTiles.push(tile);
  };
  ```
