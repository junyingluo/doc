### 目标

- 相机位于 $z$ 轴的 $0$ 点

* 将观察空间 $\{l \sim r,b \sim t,-n \sim -f\}$ 映射到设备空间 $\{-1 \sim 1,-1 \sim 1,-1 \sim 1\}$，其中 $f> n > 0$

<img src="assets/4.1 透视投影/gl_projectionmatrix01.png" width="70%" height="70%" />

- http://www.songho.ca/opengl/gl_projectionmatrix.html

### 推导

- 在观察空间中根据近大远小原理，得到 $x_p$ 和 $y_p$
  - $\frac{x_p}{x_e} = \frac{-n}{z_e} \Rightarrow x_p = \frac{-n}{z_e} \cdot x_e $

    <img src="assets/4.1 透视投影/gl_projectionmatrix02.png" width="40%" height="40%" />
  * $\frac{y_p}{y_e} = \frac{-n}{z_e} \Rightarrow y_p = \frac{-n}{z_e} \cdot y_e $

    <img src="assets/4.1 透视投影/gl_projectionmatrix03.png" width="40%" height="40%" />

* 将观察空间中 $x_p$ 和 $y_p$ 映射到设备空间 $x_n$ 和 $y_n$

  $$x_n = \frac{2x_p}{r-l} - \frac{r+l}{r-l} $$

  $$y_n = \frac{2y_p}{t-b} - \frac{t+b}{t-b} $$

* 将 $ x_p = \frac{-n}{z_e} \cdot x_e $ 和 $ y_p = \frac{-n}{z_e} \cdot y_e $ 代入，得到 $x_n$ 和 $x_e$，以及 $x_n$ 和 $x_e$ 的映射关系

  $$x_n = \frac{(\frac{2n}{r-l} \cdot x_e + \frac{r+l}{r-l} \cdot z_e)}{-z_e} $$

  $$y_n = \frac{(\frac{2n}{r-l} \cdot y_e + \frac{r+l}{r-l} \cdot z_e)}{-z_e} $$

* 得到投影关系

  $$x_n= \dfrac{x_c}{-z_e}, y_n= \dfrac{y_c}{-z_e}, z_n= \dfrac{z_c}{-z_e} $$

  $$
  \begin{bmatrix}
  x_c\\y_c\\z_c\\-z_e
  \end{bmatrix}
  =
  \begin{bmatrix}
  \dfrac{2n}{r-l} & 0 & \dfrac{r+l}{r-l} & 0 \\
  0 & \dfrac{2n}{t-b} & \dfrac{t+b}{t-b} & 0 \\
  0 & 0 & A & B \\
  0 & 0 & -1 & 0
  \end{bmatrix}
  \begin{bmatrix}
  x_e\\y_e\\z_e\\1
  \end{bmatrix}
  $$

* 得到 $z_n = \frac{z_c}{-z_e} = \frac{Az_e+B}{-z_e} $，代入 $(-f, 1)$ 和 $(-n, -1)$，可以求得 $A$ 和 $B$

  $$
  \begin{bmatrix}
  \dfrac{2n}{r-l} & 0 & \dfrac{r+l}{r-l} & 0 \\
  0 & \dfrac{2n}{t-b} & \dfrac{t+b}{t-b} & 0 \\
  0 & 0 & -\dfrac{f+n}{f-n} & -\dfrac{2fn}{f-n} \\
  0 & 0 & -1 & 0
  \end{bmatrix}
  $$

### FOV

- $w=2r$，$h=2t$，$aspect=r/t$，$fov=\theta$，$fov=\tan{\dfrac{\theta}{2}}=\dfrac{t}{n}$，则

$$
\begin{bmatrix}
\dfrac{1}{aspect \cdot \tan{\dfrac{\theta}{2}}} & 0 & 0 & 0 \\
0 & \dfrac{1}{\tan{\dfrac{\theta}{2}}} & 0 & 0 \\
0 & 0 & -\dfrac{f+n}{f-n} & -\dfrac{2fn}{f-n} \\
0 & 0 & -1 & 0
\end{bmatrix}
$$

<img src="assets/4.1 透视投影/gl_projectionmatrix14.png" width="40%" height="40%" />

### z-fighting

- 在透视投影中，深度变化并不是线性，在 f-n 很大的情况下，在远平面附近，z_e 很大的变化对应 z_n 很小的变化，因而会导致一个深度精度问题，称为深度冲突 (z-fighting)

  ![alt text](<assets/4.1 透视投影/gl_projectionmatrix04.png>)

- 当几何图形或者物体的两个表面极为接近时，就会使得表面看上去斑斑点点

  <img src="assets/4.1 透视投影/z1.png" width="20%" height="20%" />

- 可以采用多边形偏移解决，该机制将会自动在 z 值加上一个偏移量

  ```js
  gl.enable(gl.POLYGON_OFFSEF_FILL);
  gl.polygonOffset(factor, units);
  ```

  - 偏移值计算公式为 $offset = (m \cdot factor) + (r \cdot units)$，其中：
    - m 是多边形的深度的斜率，一个多边形越是与近裁剪面（near clipping plan）平行，m 就越接近 0。
    - r 是可分辨的差异的最小值，由具体实现 OpenGL 的平台指定的一个常量
    * 一般 polygonOffset 取 (1,0) 或 (1,1) 即可

  <img src="assets/4.1 透视投影/z2.png" width="20%" height="20%" />

### Reverse z

- 深度测试时，由于 z-fighting 问题，可能导致精度不够，此时可以设置 glDepthRangef(1,0)，然后用 gl.depthFunc(WebGLConstants.GREATER) 进行测试

* glDepthRangef(n,f) 将 $-1$ 和 $1$ 点映射到 $n$ 到 $f$ 之间，其中 $f > n > 0$

  $$z_w = \dfrac{f-n}{2}z_n + \dfrac{f+n}{2}$$

* 浮点数 $ (-1)^{\text{sign}} \times 1.\text{fraction} \times 2^{\text{exponent} - 127} $
  - 32 位浮点数，sign（1 位），exponent（8 位），fraction（23 位）
  * 对于 $[2^{e}, 2^{e+1})$ 之间的数，其精度为 $\dfrac{2^{e}}{2^{f}}$，由此可知越靠近 0 点，精度越高

* Reverse z 是指 glDepthRangef 设置 (1,0) 而非 (0,1)，此时用 WebGLConstants.GREATER 进行测试
