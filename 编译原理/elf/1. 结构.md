### 布局

![alt text](assets/elf.png)

### ELF Header

- 通过 e_phoff、e_phnum、e_phentsize，可以定位程序头表项
- 通过 e_shoff、e_shentsize、e_shnum，可以定位节头表项
- 通过 e_entry，可以定位程序入口

```c++
#define EI_NIDENT 16
typedef struct {
    unsigned char e_ident[EI_NIDENT]; // ELF标识符
    Elf32_Half    e_type;             // 文件类型
    Elf32_Half    e_machine;          // 目标架构
    Elf32_Word    e_version;          // ELF版本
    Elf32_Addr    e_entry;            // 程序入口点
    Elf32_Off     e_phoff;            // 程序头表偏移
    Elf32_Off     e_shoff;            // 节头表偏移
    Elf32_Word    e_flags;            // 处理器特定标志
    Elf32_Half    e_ehsize;           // ELF头部大小
    Elf32_Half    e_phentsize;        // 程序头表项大小
    Elf32_Half    e_phnum;            // 程序头表项数量
    Elf32_Half    e_shentsize;        // 节头表项大小
    Elf32_Half    e_shnum;            // 节头表项数量
    Elf32_Half    e_shstrndx;         // 节名称字符串表索引
} Elf32_Ehdr;
```

```bash
ELF Header:
  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00
  Class:                             ELF64
  Data:                              2's complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Position-Independent Executable file)
  Machine:                           Advanced Micro Devices X86-64
  Version:                           0x1
  Entry point address:               0x11a0
  Start of program headers:          64 (bytes into file)
  Start of section headers:          30768 (bytes into file)
  Flags:                             0x0
  Size of this header:               64 (bytes)
  Size of program headers:           56 (bytes)
  Number of program headers:         13
  Size of section headers:           64 (bytes)
  Number of section headers:         32
  Section header string table index: 31
```

### 程序头表（用于程序运行和加载）

```c++
typedef struct {
    Elf32_Word p_type;    // 段类型
    Elf32_Off  p_offset;  // 段在文件中的偏移
    Elf32_Addr p_vaddr;   // 段在内存中的虚拟地址
    Elf32_Addr p_paddr;   // 物理地址(通常与虚拟地址相同)
    Elf32_Word p_filesz;  // 段在文件中的大小
    Elf32_Word p_memsz;   // 段在内存中的大小
    Elf32_Word p_flags;   // 段标志(读/写/执行)
    Elf32_Word p_align;   // 段对齐方式
} Elf32_Phdr;
```

### 节头表（数据目录）

- 根据 sh_addr 和 sh_size 找到对应段

```c++
typedef struct {
    Elf32_Word sh_name;      // 节名称(字符串表索引)
    Elf32_Word sh_type;      // 节类型
    Elf32_Word sh_flags;     // 节标志
    Elf32_Addr sh_addr;      // 节在内存中的地址
    Elf32_Off  sh_offset;    // 节在文件中的偏移
    Elf32_Word sh_size;      // 节大小
    Elf32_Word sh_link;      // 链接到其他节的索引
    Elf32_Word sh_info;      // 附加信息
    Elf32_Word sh_addralign; // 节对齐方式
    Elf32_Word sh_entsize;   // 条目大小(如果有)
} Elf32_Shdr;
```

### ELF 工具链与实用命令

- 查看 ELF 文件信息

```bash
readelf -h file    # 查看ELF头部
readelf -l file    # 查看程序头表
readelf -S file    # 查看节头表
readelf -s file    # 查看符号表
readelf -d file    # 查看动态段
```

- 反汇编和查看目标文件信息

```bash
objdump -d file    # 反汇编代码段
objdump -x file    # 显示所有头信息
objdump -r file    # 显示重定位条目
```

- 查看符号表

```bash
nm file            # 显示符号表
nm -D file         # 显示动态符号表(共享库)
```

- 杂

```bash
file elf_file      # 快速识别文件类型
ldd elf_file       # 查看动态库依赖
strip elf_file     # 去除符号表和调试信息
```

### 参考

https://github.com/astrotycoon/Executable-And-Linking-Format-ELF
