### 架构

<img src="assets/屏幕截图 2025-04-11 213050.png" width="50%" height="50%"/>

### AstNode

- AstNode 层，每个节点都有 check 函数，通过函数重载，区分 ETSChecker 还是 TSChecker

```c++
checker::VerifiedType BlockStatement::Check([[maybe_unused]] checker::ETSChecker *checker)
{
    return {this, checker->GetAnalyzer()->Check(this)};
}
checker::Type *BlockStatement::Check([[maybe_unused]] checker::TSChecker *checker)
{
    return checker->GetAnalyzer()->Check(this);
}
```

### ETSAnalyzer

- 每个 AstNode 节点都对应 Check 函数，其中一个功能是，调用子节点的 Check 函数

```c++
checker::Type *ETSAnalyzer::Check(ir::ClassDeclaration *st) const
{
    ETSChecker *checker = GetETSChecker();
    st->Definition()->Check(checker);
    return ReturnTypeForStatement(st);
}
```

- 如果本节点是 Typed 节点，则调用对应 ETSChecker 函数，来设置 TsType

```c++
// ClassDefinition 是 TypedAstNode 派生类，需要设置 TsType
checker::Type *ETSAnalyzer::Check(ir::ClassDefinition *node) const
{
    ETSChecker *checker = GetETSChecker();

    if (node->TsType() == nullptr) {
        checker->BuildBasicClassProperties(node);
    }

    if (!node->IsClassDefinitionChecked()) {
        checker->CheckClassDefinition(node);
    }

    return node->TsType();
}
```

### ETSChecker

- 为 ClassDefinition 设置 TsType

```c++
Type *ETSChecker::BuildBasicClassProperties(ir::ClassDefinition *classDef)
{
    auto *var = classDef->Ident()->Variable();

    checker::ETSObjectType *classType {};
    if (var->TsType() == nullptr) {
        classType = CreateETSObjectTypeOrBuiltin(classDef, checker::ETSObjectFlags::CLASS);
        classType->SetVariable(var);
        var->SetTsType(classType);
        if (classDef->IsAbstract()) {
            classType->AddObjectFlag(checker::ETSObjectFlags::ABSTRACT);
        }
    } else {
        classType = var->TsType()->AsETSObjectType();
    }

    classDef->SetTsType(classType);
    ......
    return classType;
}
```
